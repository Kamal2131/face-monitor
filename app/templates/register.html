{% extends "base.html" %}
{% block title %}Register{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <div class="card shadow-lg p-4" style="width: 100%; max-width: 500px;">
    <h2 class="text-center mb-4">Register</h2>

    {% if msg %}
      <div class="alert alert-danger text-center">{{ msg }}</div>
    {% endif %}

    <form id="registerForm" method="post" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="name" class="form-label">Username</label>
        <input name="name" id="name" type="text" class="form-control" placeholder="Enter name" required />
      </div>

      <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input name="password" id="password" type="password" class="form-control" placeholder="Enter password" required />
      </div>

      <div class="mb-3 text-center">
        <label class="form-label d-block">Capture Your Face</label>
        <video id="video" width="320" height="240" autoplay class="border rounded shadow-sm mb-2"></video><br>
        <button type="button" class="btn btn-outline-primary" onclick="capture()">ðŸ“¸ Capture</button><br>
        <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
        <input type="hidden" name="face_image_data" id="face_image_data" />
      </div>

      <div class="d-grid mt-3">
        <button type="submit" class="btn btn-success">Sign Up</button>
      </div>
    </form>

    <div class="text-center mt-3">
      <p>Already have an account? <a href="/login">Login here</a></p>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const faceImageData = document.getElementById('face_image_data');

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      alert("Camera access denied or not available.");
      console.error(err);
    });

  function capture() {
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg');
    faceImageData.value = dataUrl;
    alert("Photo captured successfully!");
  }

  document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const base64Data = form.face_image_data.value;
    if (!base64Data) {
      alert("Please capture an image first.");
      return;
    }

    const res = await fetch(base64Data);
    const blob = await res.blob();
    formData.append("face_image", blob, "face.jpg");

    fetch("/register", {
      method: "POST",
      body: formData
    }).then(res => {
      if (res.redirected) {
        window.location.href = res.url;
      } else {
        res.text().then(html => document.body.innerHTML = html);
      }
    });
  });
</script>
{% endblock %}
