{% extends "base.html" %} {% block title %}Secure Exam Proctoring{% endblock %}
{% block content %}
<div class="container py-5">
  <!-- Exam Setup -->
  <div id="exam-setup" class="card mb-4">
    <div class="card-body">
      <h3>Exam Setup</h3>
      <div class="mb-3">
        <label class="form-label">Topic</label>
        <input
          type="text"
          class="form-control"
          id="exam-topic"
          placeholder="e.g. Python"
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Number of Questions</label>
        <input
          type="number"
          class="form-control"
          id="num-questions"
          value="5"
          min="1"
          max="20"
        />
      </div>
      <button class="btn btn-primary" id="start-exam-btn">Start Exam</button>
    </div>
  </div>

  <!-- Quiz Section -->
  <div id="quiz-section" class="d-none">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between">
        <h4>Exam: <span id="quiz-topic-title"></span></h4>
        <span>Time: <span id="quiz-timer">30:00</span></span>
      </div>
      <div class="card-body">
        <div id="questions-loading" class="text-center">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3">Generating quiz...</p>
        </div>
        <form id="quiz-form" style="display: none">
          <div id="questions-list"></div>
          <button type="submit" class="btn btn-success mt-4">
            Submit Answers
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Result Section -->
  <div id="result-section" class="d-none">
    <div class="card">
      <div class="card-body">
        <h3 class="mb-3">Your Score: <span id="score-display"></span></h3>
        <div id="detailed-results" class="mb-4"></div>

        <div class="d-flex justify-content-between">
          <a href="/dashboard" class="btn btn-outline-primary">
            <i class="fas fa-chart-bar me-2"></i> View Results
          </a>
          <button
            class="btn btn-outline-secondary"
            onclick="window.location.reload();"
          >
            <i class="fas fa-redo me-2"></i> Re-Exam
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const state = {
    questions: [],
    answers: {},
    timer: null,
    timeLeft: 30 * 60,
  };

  // Format timer
  function updateTimerDisplay() {
    const timerEl = document.getElementById("quiz-timer");
    const mins = String(Math.floor(state.timeLeft / 60)).padStart(2, "0");
    const secs = String(state.timeLeft % 60).padStart(2, "0");
    timerEl.textContent = `${mins}:${secs}`;
  }

  // Start timer countdown
  function startTimer() {
    updateTimerDisplay();
    state.timer = setInterval(() => {
      state.timeLeft--;
      updateTimerDisplay();
      if (state.timeLeft <= 0) {
        clearInterval(state.timer);
        submitQuiz();
        alert("Time's up! Your answers were auto-submitted.");
      }
    }, 1000);
  }

  // Render questions
  function renderQuestions(questions) {
    const container = document.getElementById("questions-list");
    container.innerHTML = "";
    questions.forEach((q, i) => {
      const optionsHtml = q.options
        .map((opt, idx) => {
          const letter = String.fromCharCode(65 + idx);
          return `
        <div class="form-check">
          <input class="form-check-input" type="radio" name="q${i}" id="q${i}-${letter}" value="${letter}">
          <label class="form-check-label" for="q${i}-${letter}">${letter}. ${opt}</label>
        </div>`;
        })
        .join("");
      container.innerHTML += `
      <div class="mb-4">
        <h5>Q${i + 1}: ${q.question}</h5>
        ${optionsHtml}
      </div>`;
    });
  }

  // Submit quiz
  function submitQuiz() {
    clearInterval(state.timer);

    const form = document.getElementById("quiz-form");
    const formData = new FormData(form);
    const answers = {};
    for (let [key, value] of formData.entries()) {
      const index = parseInt(key.slice(1));
      answers[index] = value;
    }

    let score = 0;
    const resultsHtml = [];
    state.questions.forEach((q, i) => {
      const correct = q.answer;
      const userAns = answers[i] || "Not answered";
      const isCorrect = userAns === correct;
      if (isCorrect) score++;

      resultsHtml.push(`
      <div class="card mb-3 border ${
        isCorrect ? "border-success" : "border-danger"
      }">
        <div class="card-body">
          <h5>Q${i + 1}: ${q.question}</h5>
          <p><strong>Your Answer:</strong> 
            <span class="${isCorrect ? "text-success" : "text-danger"}">
              ${userAns} ${isCorrect ? "✅" : "❌"}
            </span>
          </p>
          <p><strong>Correct Answer:</strong> <span class="text-success">${correct}</span></p>
          ${
            !isCorrect && q.explanation
              ? `
            <div class="alert alert-warning mt-3">
              <strong>Explanation:</strong> ${q.explanation}
            </div>`
              : ""
          }
        </div>
      </div>
    `);
    });

    // Hide quiz section and show results
    document.getElementById("quiz-section").classList.add("d-none");
    document.getElementById("result-section").classList.remove("d-none");
    document.getElementById(
      "score-display"
    ).textContent = `${score}/${state.questions.length}`;
    document.getElementById("detailed-results").innerHTML =
      resultsHtml.join("");

    // Send score to backend
    fetch("/submit-score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        topic: document.getElementById("exam-topic").value,
        score: score,
        total: state.questions.length,
      }),
    });
  }

  // Start exam
  document
    .getElementById("start-exam-btn")
    .addEventListener("click", async () => {
      const topic = document.getElementById("exam-topic").value.trim();
      const numQuestions = parseInt(
        document.getElementById("num-questions").value
      );

      if (!topic || !numQuestions) {
        alert("Please enter a topic and number of questions.");
        return;
      }

      document.getElementById("exam-setup").classList.add("d-none");
      document.getElementById("quiz-section").classList.remove("d-none");
      document.getElementById("quiz-topic-title").textContent = topic;

      try {
        const res = await fetch("/generate-mcqs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic: topic, num_questions: numQuestions }),
        });
        const data = await res.json();
        state.questions = data.questions;
        renderQuestions(state.questions);
        document.getElementById("questions-loading").style.display = "none";
        document.getElementById("quiz-form").style.display = "block";
        startTimer();
      } catch (err) {
        document.getElementById(
          "questions-loading"
        ).innerHTML = `<p class="text-danger">Failed to load quiz. Try again.</p>`;
        console.error("Error loading questions:", err);
      }
    });

  // Submit form handler
  document.getElementById("quiz-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
    submitQuiz();
  });
</script>
{% endblock %}
